```
+++ 
author = "kmplex" 
title = "unit testing (1)" 
date = "2021-12-29" 
description = "unit testing 1부"  
series = ["unit testing"] 
categories = ["dev","test"] 
+++
```

[Unit Testing](http://www.yes24.com/Product/Goods/104084175)를 읽고 짤게 정리한 내용입니다.

## 1부 더 큰 그림 


## 1장 단위 테스트의 목표 


#### 단위 테스트 현황 

- `단위 테스트를 배운다`는 것은, Framework 및 lib 를 익히는 것에 그치지 않아야하며, 테스트를 작성하는 것보다 더 큰 범주이다.
- 테스트에 소요되는 시간을 줄이고, 이득을 최대화하는 것이다.

> 테스트에 소요되는 시간이란, 단순히 작성 및 도는 시간을 의미하는게 아닌, 이해하고 유지보수하는 시간도 함께 의미한다.

- 좋은 테스트와 좋지 않은 테스트의 차이는 취향 / 개인의 선호도의 문제가 아니며, Project 의 성패를 가르는 문제이다.
- Test를 작성하기 어려운 코드는 나쁜 코드임이 확실하나, 작성하기 쉬운 코드가 반드시 좋은 코드는 아니다. 

> 낮은 겹합도가 아닌지 의심해봐야한다.

#### 단위 테스트의 목표

- `단위 테스트의 목표` 는 `Project의 지속 가능한 성장` 이다. 
- 지속성 / 확장성이 핵심이며, Test 가 있다고해서 지속성 / 확장성이 증가하는 것은 아니다.

> ex) 기반코드 Refactoring 시, Test 를 같이 변경해야하는 경우

- 서비스 코드가 많아질수록, 유지비용 / 버그 면적이 넓어진다.
- Test 도 버그에 취약하며, 유지보수가 필요하다.

#### 테스트 스위트 품질 측정을 위한 커버리지 지표

- `Coverage`가 너무 낮으면, Test 가 필요하다는 의미이지만, 높다고해서 좋은 Test 임이 보장되지 않는다.
- Coverage 로 테스트의 품질을 신뢰할 수 없다.

> Coverage 가 안좋은 지표라는 의미는 아니며, 목표로 여겨서는 안된다. (외부 Lib 들은 검증이 안되는 Case)

#### 무엇이 성공적인 테스트 스위트를 만드는가 ?

- 개발 주기에 통합되어 있으며, 중요한 비즈니스 로직을 테스트해야한다.
- 최소한의 유지비용으로 최대한의 이득을 도출할 수 있어야한다.
- 이 책의 목표는 아래와 같다.

```
- 가치있는 Test 를 식별하는 방법
- 가치있는 Test 를 작성하는 방법 
```

#### 2장 단위 테스트란 무엇인가 ?

- 단위테스트란 `격리된 방식으로 처리하는 자동화된 테스트` 이다.
- 격리를 해석함에 있어, 고전파/ 런던파로 나뉨

`런던파` Test 대역으로 의존 객체들을 대체한다.

> Test 대상을 격리한다.

장점

- 원하는 상황을 쉽게 만들 수 있다.
- 1:1 로 Test Suit가 구성되며, 어느 부분이 문제가 되었는지 쉽게 알 수 있다.

단위의 개념을 Class로 보는 관점

`고전파` 테스트 간의 격리 

- 테스트는 서로 영향을 받아서는 안된다.

`의존성`

`공유 의존성` Test 간에 서로 영향을 줄 수 있는 의존성 (DB 및 cache)
`비공개 의존성` 공유하지 않는 의존성 (영향을 주지 않음)
`불변 의존성` Value Object 를 의미 

`런던파` 는 불변 의존 외 모든 의존성에 대역을 사용하며, 단일 Class 로 테스트의 크기가 구성된다.
`고전파` 는 공유 의존에만 대역을 사용하며, Class 혹은 ClassSet 로 테스트의 크기가 구성한다.

`차이` => 격리 문제를 어떻게 다룰 것인가 / 단위의 크기를 어떻게 정의할 것인가?

저자는 런던파를 더 선호하는데, Test 의 목적이 비즈니스 로직을 확인하는 것이고, 하나의 클래스를 테스트하는것보다 객체간의 관계 (ClassSet)을 Test 하는게 더 낫다고 말함.

또한 테스트 대역을 통해 격리할 만큼 큰 그래프가 있다면, 오히려 잘못된 설계를 의심해봐야한다고 말함.
---
`개인적인 의견` : Layer 에 따라 다를것 같음.
domain Layer 에는 테스트 대역을 사용하지 않는것에 동의하나, Presentation / Application / infra layer 에선 Mocking 을 통한 상황을 만드는게 비용 대비 장점이 있다고 생각됨.  (End to End Test 가 있다는 전제하에)

Cache 에서 값을 가져온다거나, Transaction 동작 테스트는 대역을 사용하지 않고는 구현하기 까다로움.

고전파를 더 선호하나, 테스트 대역을 사용을 피하는건 옳지 않은거 같다.
---

- 고전파 / 런던파의 또 다른 의미

`Bottom up` 고전파 (TDD cycle)
`Top down` 런던파 (ATDD cycle)

- 통합 테스트란 공유 의존성 / 프로세스 외부 의존성등, 코드가 통합되어 동작하는지 검증한다.
- End to End 도 통합 테스트의 일부이며, 명확한 분리는 어렵다.

#### 3장 단위 테스트 구조

#### 단위 테스트를 구성하는 방법 

- AAA(Arrange/Act/Assert) pattern 사용 => Given / When / Than 과 동일
- 여러개의 검증 / 실행 구문 사용 피하기 

> 검증 -> 실행 -> 검증 -> 실행의 구조일 경우, 함수가 너무 많은 역할을 하거나 Test를 분리해야할 수 있다.

- 준비 구절이 긴 경우, FactotyMethod 및 비공개 Method 로 분리하는게 좋다.
- 실행 구절이 2개 이상인 경우, 캡슐화 위반이 아닌지 경계하라 (utility / infra code 는 그럴 수 있음)
- 검증 구절이 긴 경우, 적절한 equals 함수를 구현하는게 좋음
- Test 대상 시스템을 구별하기 위해 sut 로 정의하라

#### Test 간 Fixture 재사용 

- @Before 에서 Fixture 를 초기화하는것은 좋지 않다.

> Test 간 결합도가 생기며, 가독성이 떨어진다. (Test method 외에 다른 부분도 봐야함)
> DB 설정들은 사용 가능

- Factory 함수로 분리하면, 위 단점이 사라진다.

#### 명명법

- `대상메서드_시나리오_결과` 는 도움이 되지 않는 명명법이다. (@DisplayName 있어서, 상대적으로 덜 중요한 느낌)
- 시나리오를 이해할 수 있게 테스트 이름을 작성해야한다.
- Application 동작을 테스트 하는 것이므로, 테스트 대상 함수명을 적지않아야한다.

> Test 와 실제 코드간의 결합이 생긴다.

#### 매개변수화된 테스트 리펙터링하기

- Paramterized 를 이용해 테스트 데이터를 설정할 수 있다.


















