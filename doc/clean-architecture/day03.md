```
+++
author = "kmplex"
title = "만들면서 배우는 클린아키텍처 3일차"
date = "2022-11-07"
description = "만들면서 배우는 클린 아키텍처 6장~7장"
series = ["clean architecture"]
categories = ["study","ddd"]
+++
```

## 영속성 어댑터 구현하기

#### 의존성 역전 

port adapter 사용 시, 아웃고잉 어댑터를 사용하여 의존성의 방향을 application package 에 가둘 수 있다.

#### 영속성 어댑터의 책임

```text
- 입력을 받아 데이터 베이스 포맷으로 매핑한다.
- 입력을 데이터 베이스로 보낸다
- 데이터베이스 출력을 application 포맷으로 매핑한다.
- 출력을 반환한다.
```

`key` 영속성 계층에서 application package 를 바라봐선 안됨

#### 포트 인터페이스 나누기 

포트의 인터페이스도 좁게 유지해서 관리한다. `=> ISP 원칙`

> 필요 없는 화물을 운반하는 무언가에 의존하고 있으면, 예상하지 못했던 문제가 생길 수 있다. (마틴)

`개인적인 생각`

하나의 유스케이스에서 여러개의 영속성 포트를 의존하고 있다면, 시나리오가 잘못됐다는걸 의미할 수 있음.  
이러한 방식이 의존성을 관리하고 코드를 나누는데 용이할 것으로 예상됨.

#### 영속성 어댑터 나누기 

위에서 나눈 포트를 하나의 Repository 에 구현하여 관리할 수 있음.

애그리거트당 하나의 영속성 어댑터를 사용하여, 바운디드 컨텍스트로 영속성 어댑터를 구분 할 수 있다.

> 바운디드 컨텍스트에서 다른 Repository 로 직접 접근하지 않아야하며, 인커밍 포트를 통해서만 접근해야한다.

#### 데이터베이스 트랜잭션은 어떻게 처리해야할까? 

영속성 어댑터에서는 유스케이스 단위를 구분할 수 없으므로, 유스케이스 계층에서 트랜잭션이 구현되어야한다.
annotation 을 사용할 수 있으며, 위빙을 사용할 수도 있음.

#### 유지보수 가능한 소프트웨어를 만드는데 어떻게 도움이 될까 ?

- port 를 좁게 만들어서 의존성 관리를 용이하게 할 수 있다.
- JPA 와의 구조와 도메인 구조를 다르게 가져가기 위해, 도메인과 영속성 엔티티를 분리해서 사용 할 수도 있다.
  - 이때 도메인의 요구사항에 따라, 다른 table 에 대하여 연관 어노테이션 대신, id 참조를 사용 할 수도 있다.


## 아키텍처 요소 테스트하기 

#### 테스트 피라미드 

테스트 피라미드는 계층에 따라, 유지보수성 + 리팩터링 내성 / 회귀 방지가 반비례한다.
상위 계층일 수록, 회귀 방지가 강하게 보장되나 유지보수성이 증가한다.

때문에 (상대적으로) 비용이 적게드는 단위 테스트를 더 많이 작성하며, 비용이 많이 드는 시스템 테스트는 적게 작성해야한다.

> 특별히 정리해야할 내용은 없었음



